# å·¥ä½œæµåç§°
name: æ£€æŸ¥ä»“åº“æ›´æ–°

# è§¦å‘æ¡ä»¶
on:
  schedule:
    - cron: '0 0 * * *'  # æ¯å¤© UTC 0:00 è¿è¡Œï¼ˆåŒ—äº¬æ—¶é—´ 8:00ï¼‰
  workflow_dispatch:      # æ”¯æŒæ‰‹åŠ¨è§¦å‘

# å·¥ä½œæµä»»åŠ¡
jobs:
  check-updates:
    runs-on: ubuntu-latest
    
    steps:
      # æ­¥éª¤1: è°ƒè¯•ç¯å¢ƒå˜é‡ï¼Œç¡®è®¤å˜é‡æ˜¯å¦æ­£ç¡®è®¾ç½®
      - name: è°ƒè¯•ç¯å¢ƒå˜é‡
        run: |
          echo "Variables å†…å®¹:"
          echo "REPOS: ${{ vars.REPOS }}"

      # æ­¥éª¤2: æ£€æŸ¥ä»“åº“æ›´æ–°çŠ¶æ€
      - name: æ£€æŸ¥ä»“åº“æ›´æ–°çŠ¶æ€
        id: check-updates
        env:
          REPOS: ${{ vars.REPOS }}  # ä»GitHub Variablesè·å–ä»“åº“åˆ—è¡¨
        run: |
            # è®¾ç½®æ—¶åŒºä¸ºä¸Šæµ·
            export TZ='Asia/Shanghai'
            
            # å°†ç¯å¢ƒå˜é‡è½¬æ¢ä¸ºæ•°ç»„ï¼ˆä»“åº“åˆ—è¡¨åº”è¯¥ä»¥ç©ºæ ¼åˆ†éš”ï¼Œå¦‚ï¼šowner1/repo1 owner2/repo2ï¼‰
            read -ra repos <<< "$REPOS"
            
            # åˆå§‹åŒ–å˜é‡
            updates_status="### ğŸ” ä»“åº“æ›´æ–°æ£€æŸ¥æŠ¥å‘Š\n\n"
            updates_status+="### ğŸ“… æ£€æŸ¥æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')\n\n"
            updates_status+="---\n\n"
            has_updates=false
            updated_repos=0
            total_repos=${#repos[@]}
            
            # éå†ä»“åº“åˆ—è¡¨
            for repo in "${repos[@]}"; do
              echo "å¤„ç†ä»“åº“: ${repo}"
              
              # è°ƒç”¨GitHub APIè·å–ä»“åº“ä¿¡æ¯
              repo_info=$(curl -s "https://api.github.com/repos/${repo}")
              latest_commit=$(curl -s "https://api.github.com/repos/${repo}/commits?per_page=1")
              
              # è§£æAPIè¿”å›çš„JSONæ•°æ®
              commit_date=$(echo "$latest_commit" | jq -r '.[0].commit.committer.date')
              commit_msg=$(echo "$latest_commit" | jq -r '.[0].commit.message')
              description=$(echo "$repo_info" | jq -r '.description')
              
              # è®¡ç®—æ—¶é—´å·®ï¼ˆå°æ—¶ï¼‰
              current_time=$(date +"%Y-%m-%dT%H:%M:%SZ")
              time_diff=$(( ( $(date -d "$current_time" +%s) - $(date -d "$commit_date" +%s) ) / 3600 ))
              
              # åˆ¤æ–­æ˜¯å¦æœ‰æ›´æ–°ï¼ˆ24å°æ—¶å†…ï¼‰
              if [ $time_diff -le 24 ]; then
                has_updates=true
                ((updated_repos++))
                status_icon="âœ…"
              else
                status_icon="âŒ"
              fi
              
              # æ„å»ºä»“åº“æ›´æ–°ä¿¡æ¯
              updates_status+="##### ${status_icon} ä»“åº“ï¼š${repo}\n\n"
              updates_status+="ğŸ“ **æè¿°**ï¼š${description}\n\n"
              updates_status+="â° **æœ€åæ›´æ–°**ï¼š$(date -d "$commit_date" '+%Y-%m-%d %H:%M:%S')\n\n"
              updates_status+="ğŸ“Œ **æœ€æ–°æäº¤**ï¼š${commit_msg}\n\n"
              updates_status+="â³ **çŠ¶æ€**ï¼š${time_diff}å°æ—¶æœªæ›´æ–°\n\n"
              updates_status+="---\n\n"
            done
            
            # è®¾ç½®é€šçŸ¥æ ‡é¢˜
            if [ "$has_updates" = true ]; then
              title_status="ğŸ‰ å‘ç°${updated_repos}ä¸ªä»“åº“æ›´æ–°ï¼- "
            else
              title_status="ğŸ˜´ æš‚æ— æ›´æ–° - "
            fi
            
            # æ·»åŠ ç»Ÿè®¡ä¿¡æ¯åˆ°å¼€å¤´
            stats="### ğŸ“Š ç»Ÿè®¡ä¿¡æ¯\n\n"
            stats+="- æ€»ä»“åº“æ•°ï¼š${total_repos}\n"
            stats+="- æœ‰æ›´æ–°ï¼š${updated_repos}\n"
            stats+="- æ— æ›´æ–°ï¼š$((total_repos - updated_repos))\n\n"
            stats+="---\n\n"
            
            # åˆå¹¶æ‰€æœ‰å†…å®¹
            final_status="${stats}${updates_status}"
            
            # å°†ç»“æœä¿å­˜åˆ°GitHub Actionsè¾“å‡ºå˜é‡
            {
              echo "has_updates=${has_updates}"
              echo "check_results<<EOF"
              echo -e "$final_status"
              echo "EOF"
              echo "title_prefix=${title_status}"
            } >> $GITHUB_OUTPUT

      # æ­¥éª¤3: å‘é€é€šçŸ¥
      - name: å‘é€é€šçŸ¥
        if: github.event_name == 'workflow_dispatch' || steps.check-updates.outputs.has_updates == 'true'  # æ‰‹åŠ¨è§¦å‘æˆ–æœ‰æ›´æ–°æ—¶å‘é€
        uses: candies404/Multi-Channel-Notifier@latest
        with:
          title: "${{ steps.check-updates.outputs.title_prefix }}ä»“åº“æ›´æ–°æ£€æŸ¥æŠ¥å‘Š"
          content: ${{ steps.check-updates.outputs.check_results }}
          wpush_key: ${{ secrets.wpush_key }}         # WxPusher çš„ API key
          dd_bot_secret: ${{ secrets.dd_bot_secret }} # é’‰é’‰æœºå™¨äººåŠ ç­¾å¯†é’¥
          dd_bot_token: ${{ secrets.dd_bot_token }}   # é’‰é’‰æœºå™¨äºº token
          dd_msg_type: 'markdown'                     # é’‰é’‰æ¶ˆæ¯ç±»å‹
          hitokoto: 'false'                          # æ˜¯å¦å¯ç”¨ä¸€è¨€
